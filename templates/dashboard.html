<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | iPaper</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { font-family: Arial, sans-serif; }
    .main { padding: 20px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; }
    .topbar-actions button { margin-left: 10px; }
    .main-content { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .section-title { font-weight: bold; margin-bottom: 10px; }
    .document-item { padding: 8px; margin-bottom: 6px; background: #f6f6f6; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .document-item.selected { background: #cce5ff; }
    .document-delete-btn { background: none; border: none; cursor: pointer; color: red; font-size: 16px; }
    .muted { color: #777; }
    .btn { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    #summaryBox { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-top: 10px; line-height: 1.5; white-space: pre-wrap; }
    #keywordBox { margin-top: 10px; color: #333; }
    .categories-container { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .category { padding: 8px; background: #efefef; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .category.active-category { background: #cce5ff; }
    .delete-category { background: none; border: none; cursor: pointer; color: red; }
  </style>
</head>
<body>
<div id="app">
  <main class="main">
    <div class="topbar">
      <div class="muted">{{ name }}</div>
      <div class="muted">{{ profession }}</div>
      <div class="topbar-actions">
        <button id="downloadBtn" class="btn secondary">Download</button>
        {% if latest_membership != "Free" %}
          <button id="generateBtn" class="btn btn-primary">Generate</button>
        {% else %}
          <button id="generateBtn" class="btn" disabled title="Upgrade to use Generate">Generate</button>
        {% endif %}
      </div>
    </div>

    <h1>Welcome back, {{ name }}</h1>

    <!-- Hidden form to pass file_id -->
    <form id="generateForm" class="hidden">
      <input type="hidden" name="file_id" id="form_file_id" value="">
    </form>

    <!-- Documents Section -->
    <section style="margin-top:20px;">
      <h2>Documents</h2>
      <div id="documents-container" style="margin-top:10px;"></div>
    </section>

    <!-- Category Section -->
    <section style="margin-top:20px;">
      <h2>Categories</h2>
      <button id="addCategoryBtn" class="btn">Add Category</button>
      <div class="categories-container">
        <div class="category active-category" data-category="all">
          <div class="category-title">All Documents</div>
        </div>
      </div>
    </section>

    <!-- Summary Section -->
    <div id="summary-section" class="main-content" style="margin-top:30px;">
      <div class="section-title">Generated Summary</div>
      <div id="summary-output">
        <p class="muted">No summary yet. Select a document from the list and click Generate.</p>
      </div>
      <div id="summaryBox" class="hidden"></div>
      <div id="keywordBox" style="display:none;"></div>
    </div>
  </main>
</div>

<script>
  // Utility
  const $ = (selector) => document.querySelector(selector);
  let categories = [];
  let currentCategory = 'all';

  // Load documents
  async function loadDocuments() {
    try {
      const res = await fetch('/get-documents');
      const docs = await res.json();
      const container = $('#documents-container');
      container.innerHTML = '';

      if (!Array.isArray(docs) || docs.length === 0) {
        container.innerHTML = '<p class="muted">No documents found.</p>';
        return;
      }

      docs.forEach(doc => {
        const div = document.createElement('div');
        div.className = 'document-item';
        div.textContent = doc.filename || 'Untitled';
        div.dataset.docId = doc.id;

        div.onclick = () => {
          document.querySelectorAll('.document-item').forEach(d => d.classList.remove('selected'));
          div.classList.add('selected');
          window.selectedDocId = doc.id;
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'document-delete-btn';
        delBtn.textContent = 'ðŸ—‘';
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`Delete "${doc.filename}"?`)) {
            await fetch(`/delete-document/${doc.id}`, { method: 'GET' });
            await loadDocuments();
          }
        };

        div.appendChild(delBtn);
        container.appendChild(div);
      });
    } catch (err) {
      console.error('Error loading documents:', err);
    }
  }

  // Load categories
  async function loadCategories() {
    try {
      const res = await fetch('/get_categories');
      categories = await res.json();
    } catch (err) {
      categories = [];
    }
    renderCategories();
  }

  // Render categories
  function renderCategories() {
    const container = document.querySelector('.categories-container');
    container.querySelectorAll('.category:not([data-category="all"])').forEach(el => el.remove());

    categories.forEach(category => {
      const el = document.createElement('div');
      el.className = 'category';
      el.dataset.category = category.id;
      el.innerHTML = `
        <div class="category-title">${category.name}</div>
        <button class="delete-category">ðŸ—‘</button>
      `;
      el.onclick = () => setCurrentCategory(category.id);
      el.querySelector('.delete-category').onclick = (e) => {
        e.stopPropagation();
        deleteCategory(category.id);
      };
      container.appendChild(el);
    });
  }

  // Category CRUD
  async function addCategory(name) {
    if (!name.trim()) return;
    const res = await fetch('/add_category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    const data = await res.json();
    if (data.success) loadCategories();
  }

  async function deleteCategory(id) {
    if (!confirm('Delete this category?')) return;
    await fetch(`/delete_category/${id}`, { method: 'DELETE' });
    loadCategories();
  }

  function setCurrentCategory(id) {
    currentCategory = id;
    document.querySelectorAll('.category').forEach(c => c.classList.remove('active-category'));
    const el = document.querySelector(`.category[data-category="${id}"]`);
    if (el) el.classList.add('active-category');
  }

  // Generate summary
  async function generateSummary() {
    const fileId = window.selectedDocId;
    const out = $('#summary-output');
    const summaryBox = $('#summaryBox');
    const keywordBox = $('#keywordBox');
    const btn = $('#generateBtn');

    if (!fileId) {
      out.innerHTML = '<p style="color:orange;">Please select a document first.</p>';
      return;
    }

    $('#form_file_id').value = fileId;
    btn.disabled = true;
    btn.textContent = 'Generating...';
    out.innerHTML = '<p><em>Generating summary, please wait...</em></p>';
    summaryBox.classList.add('hidden');
    keywordBox.style.display = 'none';

    try {
      const res = await fetch('/generate-summary', {
        method: 'POST',
        body: new FormData($('#generateForm'))
      });
      const data = await res.json();

      if (res.ok && data.summary) {
        out.innerHTML = `<h4>${data.filename || 'Document'}</h4><p><strong>Summary:</strong></p>`;
        summaryBox.classList.remove('hidden');
        summaryBox.innerText = data.summary;
        if (data.keywords?.length) {
          keywordBox.style.display = 'block';
          keywordBox.innerText = 'Keywords: ' + data.keywords.join(', ');
        }
      } else {
        out.innerHTML = `<p style="color:red;">Error: ${data.error || 'Unknown error'}</p>`;
      }
    } catch (err) {
      out.innerHTML = '<p style="color:red;">Network error. Please try again.</p>';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
    }
  }

  // DOM Ready
  document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    loadCategories();

    $('#generateBtn')?.addEventListener('click', generateSummary);
    $('#addCategoryBtn')?.addEventListener('click', () => {
      const name = prompt('Enter new category name:');
      if (name) addCategory(name);
    });
  });
</script>
</body>
</html>
